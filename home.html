<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cMart - Shopping & Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: whitesmoke;
            color: #333;
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        header {
            background-color: steelblue;
            color: white;
            padding: 15px;
            position: sticky;
            top: 0;
        }
        
        .app-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 20px;
            border-radius: 25px;
            border: none;
            background-color: white;
            font-size: 16px;
            padding-left: 45px;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 12px;
            color: #777;
        }
        
        main {
            padding-bottom: 70px;
        }
        
        .section-header {
            padding: 15px 15px 5px 15px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .filter-section {
            padding: 0 12px 15px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            white-space: nowrap;
        }
        
        .campus-filter {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            color: #333;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 0 12px 15px 12px;
        }
        
        .product-card {
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            position: relative;
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .product-image {
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .product-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-price {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .product-info {
            padding: 8px;
            background: rgba(248,248,248,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 45px;
        }
        
        .product-name {
            font-size: 12px;
            font-weight: 600;
            line-height: 1.2;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .services-section {
            margin: 20px 0;
            padding: 0 12px;
        }
        
        .services-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .services-scroll {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        
        .services-scroll::-webkit-scrollbar {
            display: none;
        }
        
        .service-card {
            background-color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            min-width: calc(70% - 6px); /* CHANGED FROM 50% TO 70% */
            border-radius: 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .service-image {
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            overflow: hidden;
            position: relative;
        }
        
        .service-image img {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .service-info {
            padding: 8px;
            background: rgba(248,248,248,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 45px;
        }
        
        .service-name {
            font-size: 12px;
            font-weight: 600;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.2;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }
        
        .empty-state i {
            font-size: 50px;
            color: #ccc;
            margin-bottom: 15px;
        }
        
        .search-results {
            display: none;
            padding: 15px;
            background-color: white;
            margin: 10px;
        }
        
        .result-item {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .result-image {
            width: 60px;
            height: 60px;
            background-color: #f0f0f0;
            margin-right: 15px;
            overflow: hidden;
        }
        
        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .result-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        
        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #777;
            text-decoration: none;
            width: 33.33%;
        }
        
        .nav-item.active {
            color: steelblue;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }

        /* Product Details Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .modal-image {
            width: 100%;
            height: 250px;
            overflow: hidden;
            position: relative;
        }
        
        .modal-image img {
            width: auto;
            max-width: 100%;
            height: auto;
            max-height: 100%;
            object-fit: contain; /* CHANGED FROM cover TO contain */
        }
        
        .modal-price {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .modal-content {
            padding: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .modal-description {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 15px;
            color: #555;
        }
        
        .modal-contact {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .contact-button {
            background: #25D366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .close-modal {
            background: steelblue;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        /* Admin delete button */
        .admin-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(192, 57, 43, 0.9);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            z-index: 10;
        }
        
        .admin-delete-btn:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <header>
        <div class="app-bar">
            <div class="logo">cMart</div>
        </div>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-bar" placeholder="Search products and services..." id="searchInput">
        </div>
    </header>
    
    <main id="mainContent">
        <div class="search-results" id="searchResults"></div>
        
        <!-- Campus Filter -->
        <div class="filter-section">
            <div class="filter-label">Filter by Campus:</div>
            <select class="campus-filter" id="campusFilter">
                <option value="all">All Campuses</option>
                <option value="Uli Campus">Uli Campus</option>
                <option value="Igbariam Campus">Igbariam Campus</option>
                <option value="Awka Campus">Awka Campus</option>
            </select>
        </div>
        
        <div id="contentContainer"></div>
    </main>

    <!-- Product Details Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-image">
                <img id="modalImage" alt="Product image">
                <div class="modal-price" id="modalPrice"></div>
            </div>
            <div class="modal-content">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-description" id="modalDescription"></div>
                <div class="modal-contact" id="modalContact"></div>
                <button class="contact-button" id="contactButton">
                    <i class="fab fa-whatsapp"></i>
                    <span id="contactButtonText">Contact Vendor</span>
                </button>
                <button class="close-modal" id="closeModal">Close</button>
            </div>
        </div>
    </div>
    
    <div class="nav-bar">
        <a href="home.html" class="nav-item active">
            <i class="fas fa-home nav-icon"></i>
            <span>Home</span>
        </a>
        <a href="updates.html" class="nav-item">
            <i class="fas fa-sync-alt nav-icon"></i>
            <span>Updates</span>
        </a>
        <a href="account.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Account</span>
        </a>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const contentContainer = document.getElementById('contentContainer');
        const productModal = document.getElementById('productModal');
        const modalImage = document.getElementById('modalImage');
        const modalTitle = document.getElementById('modalTitle');
        const modalPrice = document.getElementById('modalPrice');
        const modalDescription = document.getElementById('modalDescription');
        const modalContact = document.getElementById('modalContact');
        const contactButton = document.getElementById('contactButton');
        const contactButtonText = document.getElementById('contactButtonText');
        const closeModal = document.getElementById('closeModal');
        const campusFilter = document.getElementById('campusFilter');

        // IndexedDB Configuration
        const DB_NAME = 'cMartDB';
        const DB_VERSION = 1;
        const PRODUCTS_STORE = 'products';
        const SERVICES_STORE = 'services';
        let db = null;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(PRODUCTS_STORE)) {
                        database.createObjectStore(PRODUCTS_STORE, { keyPath: 'id' });
                    }
                    if (!database.objectStoreNames.contains(SERVICES_STORE)) {
                        database.createObjectStore(SERVICES_STORE, { keyPath: 'id' });
                    }
                };
            });
        }

        // Get all products from IndexedDB
        async function getAllProducts() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([PRODUCTS_STORE], 'readonly');
                const store = transaction.objectStore(PRODUCTS_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Get all services from IndexedDB
        async function getAllServices() {
            if (!db) await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([SERVICES_STORE], 'readonly');
                const store = transaction.objectStore(SERVICES_STORE);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        // Check if current user is admin
        function isAdmin() {
            const currentUser = localStorage.getItem('cmartCurrentUser');
            if (!currentUser) return false;
            
            const user = JSON.parse(currentUser);
            return user.email === 'admin@cmart.com' || user.role === 'admin';
        }

        // Helper function to delete from all user stores
        function deleteFromAllUserStores(itemId, itemType) {
            try {
                // Get all keys from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (itemType === 'service') {
                        // Look for user service stores (cmartServices_*)
                        if (key.startsWith('cmartServices_')) {
                            const userServices = JSON.parse(localStorage.getItem(key) || '[]');
                            const updatedServices = userServices.filter(item => item.id !== itemId);
                            localStorage.setItem(key, JSON.stringify(updatedServices));
                        }
                    } else {
                        // Look for user product stores (cmartStore_*)
                        if (key.startsWith('cmartStore_')) {
                            const userProducts = JSON.parse(localStorage.getItem(key) || '[]');
                            const updatedProducts = userProducts.filter(item => item.id !== itemId);
                            localStorage.setItem(key, JSON.stringify(updatedProducts));
                        }
                    }
                }
            } catch (error) {
                console.warn('Error cleaning user stores:', error);
            }
        }

        // Function to clear the 24-hour shuffle cache
        function clearShuffleCache() {
            const today = new Date().toDateString();
            const cacheKey = `cmartShuffle_${today}`;
            localStorage.removeItem(cacheKey);
        }

        // Delete item as admin - UPDATED with clearShuffleCache
        async function deleteItemAsAdmin(itemId, itemType) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                await initDB();
                const storeName = itemType === 'service' ? SERVICES_STORE : PRODUCTS_STORE;
                
                // Delete from IndexedDB
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                await store.delete(itemId);
                
                // Delete from localStorage main arrays
                if (itemType === 'service') {
                    const services = JSON.parse(localStorage.getItem('cmartServices') || '[]');
                    const updatedServices = services.filter(item => item.id !== itemId);
                    localStorage.setItem('cmartServices', JSON.stringify(updatedServices));
                    
                    // Also delete from all user service stores
                    deleteFromAllUserStores(itemId, 'service');
                } else {
                    const products = JSON.parse(localStorage.getItem('cmartProducts') || '[]');
                    const updatedProducts = products.filter(item => item.id !== itemId);
                    localStorage.setItem('cmartProducts', JSON.stringify(updatedProducts));
                    
                    // Also delete from all user product stores
                    deleteFromAllUserStores(itemId, 'product');
                }
                
                // Clear the 24-hour shuffle cache so deleted items don't reappear
                clearShuffleCache();
                
                // Reload items
                loadItems();
                showSuccess('Item deleted successfully!');
                
            } catch (error) {
                console.error('Error deleting item:', error);
                showError('Failed to delete item. Please try again.');
            }
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #1e8f3e;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 600;
            `;
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                document.body.removeChild(successDiv);
            }, 3000);
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #c0392b;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 600;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                document.body.removeChild(errorDiv);
            }, 3000);
        }

        // Shuffle array randomly
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Get shuffled items (with 24-hour cache) - UPDATED VERSION
        function getShuffledItems(items) {
            const today = new Date().toDateString();
            const cacheKey = `cmartShuffle_${today}`;
            
            // Check if we have a cached shuffle for today
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    // Parse cached shuffle order
                    const shuffledIds = JSON.parse(cached);
                    
                    // Get current items that match the cached IDs (in case some were deleted)
                    const currentItemIds = items.map(item => item.id);
                    const validCachedIds = shuffledIds.filter(id => currentItemIds.includes(id));
                    
                    // Create a map for quick lookup
                    const itemMap = {};
                    items.forEach(item => itemMap[item.id] = item);
                    
                    // Sort items according to cached order
                    const sortedItems = [];
                    validCachedIds.forEach(id => {
                        if (itemMap[id]) {
                            sortedItems.push(itemMap[id]);
                        }
                    });
                    
                    // Add any new items that weren't in the cache to the end
                    items.forEach(item => {
                        if (!validCachedIds.includes(item.id)) {
                            sortedItems.push(item);
                        }
                    });
                    
                    return sortedItems;
                } catch (e) {
                    // If cache is corrupted, create new shuffle
                    console.warn('Cache corrupted, creating new shuffle');
                    const shuffled = shuffleArray(items);
                    const shuffledIds = shuffled.map(item => item.id);
                    localStorage.setItem(cacheKey, JSON.stringify(shuffledIds));
                    return shuffled;
                }
            }
            
            // Create new shuffle and cache it
            const shuffled = shuffleArray(items);
            const shuffledIds = shuffled.map(item => item.id);
            localStorage.setItem(cacheKey, JSON.stringify(shuffledIds));
            return shuffled;
        }

        // Load items from IndexedDB
        async function loadItems() {
            try {
                await initDB();
                let products = await getAllProducts();
                let services = await getAllServices();
                
                // Fallback to localStorage if IndexedDB is empty
                if (products.length === 0) {
                    const localProducts = JSON.parse(localStorage.getItem('cmartProducts') || '[]');
                    products.push(...localProducts);
                }
                if (services.length === 0) {
                    const localServices = JSON.parse(localStorage.getItem('cmartServices') || '[]');
                    services.push(...localServices);
                }
                
                // Apply campus filter to BOTH products and services
                const selectedCampus = campusFilter.value;
                if (selectedCampus !== 'all') {
                    products = products.filter(item => item.location === selectedCampus);
                    services = services.filter(item => item.location === selectedCampus);
                }
                
                displayItems(products, services);
            } catch (error) {
                // Fallback to localStorage only
                let products = JSON.parse(localStorage.getItem('cmartProducts') || '[]');
                let services = JSON.parse(localStorage.getItem('cmartServices') || '[]');
                
                // Apply campus filter to BOTH products and services
                const selectedCampus = campusFilter.value;
                if (selectedCampus !== 'all') {
                    products = products.filter(item => item.location === selectedCampus);
                    services = services.filter(item => item.location === selectedCampus);
                }
                
                displayItems(products, services);
            }
        }

        // Display items with shuffling - UPDATED VERSION
        function displayItems(products, services) {
            if (products.length === 0 && services.length === 0) {
                contentContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-store-slash"></i>
                        <p>No products or services available</p>
                    </div>
                `;
                return;
            }
            
            const admin = isAdmin();
            
            // Get shuffled products (changes every 24 hours)
            const shuffledProducts = getShuffledItems(products);
            
            let html = '';
            let productCount = 0;
            const productsPerRow = 2;
            const rowsBeforeServices = Math.floor(Math.random() * 3) + 5; // 5-7 rows
            
            // Display products with services inserted every 5-7 rows
            if (shuffledProducts.length > 0) {
                shuffledProducts.forEach((product, index) => {
                    // Insert services section every X rows of products
                    if (productCount % (rowsBeforeServices * productsPerRow) === 0 && productCount > 0 && services.length > 0) {
                        html += createServicesSection(services, admin);
                    }
                    
                    // Start new row
                    if (productCount % productsPerRow === 0) {
                        if (productCount > 0) html += '</div>';
                        html += '<div class="products-grid">';
                    }
                    
                    html += `
                        <div class="product-card">
                            <div class="product-image" onclick="showProductDetails('${product.id}', 'product')">
                                <img src="${product.image}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                                ${product.price ? `<div class="product-price">₦${product.price}</div>` : ''}
                                ${admin ? `
                                    <div class="admin-delete-btn" onclick="event.stopPropagation(); deleteItemAsAdmin('${product.id}', 'product')">
                                        <i class="fas fa-times"></i>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.productName}</div>
                            </div>
                        </div>
                    `;
                    
                    productCount++;
                    
                    // Close row at the end
                    if (index === shuffledProducts.length - 1 || (productCount % productsPerRow === 0 && productCount > 0)) {
                        html += '</div>';
                    }
                });
            }
            
            // Add services at the end if there are any left
            if (services.length > 0) {
                html += createServicesSection(services, admin);
            }
            
            contentContainer.innerHTML = html;
        }

        function createServicesSection(services, admin) {
            return `
                <div class="services-section">
                    <div class="services-title">Available Services</div>
                    <div class="services-scroll">
                        ${services.map(service => `
                            <div class="service-card">
                                <div class="service-image" onclick="showProductDetails('${service.id}', 'service')">
                                    <img src="${service.image}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                                    ${admin ? `
                                        <div class="admin-delete-btn" onclick="event.stopPropagation(); deleteItemAsAdmin('${service.id}', 'service')">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="service-info">
                                    <div class="service-name">${service.brandName}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Show product details in modal
        async function showProductDetails(itemId, itemType) {
            try {
                const products = await getAllProducts();
                const services = await getAllServices();
                const allItems = [...products, ...services];
                
                const item = allItems.find(i => i.id === itemId);
                
                if (item) {
                    modalImage.src = item.image;
                    modalTitle.textContent = item.productName || item.brandName;
                    
                    // Only show price for products, not services
                    if (itemType === 'product' && item.price) {
                        modalPrice.textContent = '₦' + item.price;
                        modalPrice.style.display = 'block';
                    } else {
                        modalPrice.style.display = 'none';
                    }
                    
                    modalDescription.textContent = item.description;
                    
                    // Set contact message based on item type
                    if (itemType === 'product') {
                        modalContact.textContent = 'Contact vendor to purchase the product';
                        contactButtonText.textContent = 'Contact Vendor';
                    } else {
                        modalContact.textContent = 'Contact us for more information on our services';
                        contactButtonText.textContent = 'Contact Us';
                    }
                    
                    // Set up WhatsApp contact
                    contactButton.onclick = function() {
                        if (item.contactLink) {
                            window.open(item.contactLink, '_blank');
                        }
                    };
                    
                    productModal.classList.add('active');
                }
            } catch (error) {
                // Fallback to localStorage
                const products = JSON.parse(localStorage.getItem('cmartProducts') || '[]');
                const services = JSON.parse(localStorage.getItem('cmartServices') || '[]');
                const allItems = [...products, ...services];
                
                const item = allItems.find(i => i.id === itemId);
                
                if (item) {
                    modalImage.src = item.image;
                    modalTitle.textContent = item.productName || item.brandName;
                    
                    // Only show price for products, not services
                    if (itemType === 'product' && item.price) {
                        modalPrice.textContent = '₦' + item.price;
                        modalPrice.style.display = 'block';
                    } else {
                        modalPrice.style.display = 'none';
                    }
                    
                    modalDescription.textContent = item.description;
                    
                    // Set contact message based on item type
                    if (itemType === 'product') {
                        modalContact.textContent = 'Contact vendor to purchase the product';
                        contactButtonText.textContent = 'Contact Vendor';
                    } else {
                        modalContact.textContent = 'Contact us for more information on our services';
                        contactButtonText.textContent = 'Contact Us';
                    }
                    
                    // Set up WhatsApp contact
                    contactButton.onclick = function() {
                        if (item.contactLink) {
                            window.open(item.contactLink, '_blank');
                        }
                    };
                    
                    productModal.classList.add('active');
                }
            }
        }

        // Close modal
        closeModal.addEventListener('click', function() {
            productModal.classList.remove('active');
        });

        // Search functionality
        searchInput.addEventListener('input', async function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                searchR